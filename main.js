(()=>{"use strict";class t{constructor(){this.form=document.createElement("form"),this.body=document.querySelector("body")}create(){this.form.className="createTicket",this.form.innerHTML='\n      <fieldset>\n        <legend>Добавить тикет</legend>\n        <label>\n          Краткое описание\n          <input name="name" type="text" required="true">\n        </label>\n        <br>\n        <label>\n          Подробное описание\n          <textarea name="description" cols="40" rows="3" required="true"></textarea>\n        </label>\n      </fieldset>\n      <button type="button" class="cancel">Отмена</button> \n      <button type="button" class="verification">ОК</button>\n    ',this.body.appendChild(this.form)}edit(t){this.form.className="editTicket",this.form.innerHTML=`\n      <fieldset>\n        <legend>Изменить тикет</legend>\n        <label>\n          Краткое описание\n          <input name="name" type="text" value="${t.name}">\n        </label>\n        <br>\n        <label>\n          Подробное описание\n          <textarea name="description" cols="40" rows="3">${t.description}</textarea>\n        </label>\n      </fieldset>\n      <button type="button" class="cancel">Отмена</button> \n      <button type="button" class="redact">ОК</button> \n    `,this.body.appendChild(this.form)}delete(){this.form.className="deleteTicket",this.form.innerHTML='\n      <fieldset>\n        <legend>Удалить тикет</legend>\n        <label>\n          Вы уверены, что хотите удалить тикет? \n Это действие необратимо.\n        </label>\n      <button type="button" class="cancel">Отмена</button> \n      <button type="button" class="delete__record">ОК</button> \n    ',this.body.appendChild(this.form)}show(){this.form.style.display="block",this.form.style.position="absolute",this.form.style.top=0,this.form.style.bottom=0,this.form.style.left=0,this.form.style.right=0,this.form.style.margin="auto"}remove(){this.body.removeChild(this.form)}}class e{async list(){let t=await fetch("http://localhost:7070?method=allTickets");if(t.ok){return t.json()}console.log("Ошибка HTTP: "+t.status)}async get(t){let e=`http://localhost:7070?method=ticketById&id=${t}`,n=await fetch(e);if(n.ok){return await n.json()}console.log("Ошибка HTTP: "+n.status)}async create(t){let e=`http://localhost:7070?method=createTicket&${t}`,n=await fetch(e,{method:"POST"});if(n.ok){return await n.json()}console.log("Ошибка HTTP: "+n.status)}async update(t){let e=`http://localhost:7070?method=updateById&${t}`,n=await fetch(e,{method:"PATCH"});if(n.ok){return await n.json()}console.log("Ошибка HTTP: "+n.status)}async delete(t){let e=`http://localhost:7070?method=deleteById&${t}`;return console.log(e),await fetch(e,{method:"DELETE"})}}class n{constructor(t){if(!(t instanceof HTMLElement))throw new Error("This is not HTML element!");this.table=t}allTickets(t){for(let e=0;e<t.length;e++){this.table.innerHTML+=`\n      <tr class ="table__row">\n      <td class="id">${t[e].id}</td>\n      <td class="status"><input type="checkbox" class="check"></td>\n      <td class="name">${t[e].name}</td>\n      <td class="created">${t[e].created}</td>\n      <td class="edit"><button type="button" class="edit__ticket">&#9998;</button></td>\n      <td class="delete"><button type="button" class="delete__ticket">&#10005;</button></td>\n      </tr>\n      `;const n=document.getElementsByTagName("input");for(let s=e;s<n.length;s++)void 0!==t[s]&&t[s].status&&n[s].setAttribute("checked","checked")}}}function s(t){const{elements:e}=t;return Array.from(e).map((t=>{const{name:e,type:n}=t;return{name:e,value:"checkbox"===n?t.checked:t.value}})).filter((t=>!!t.name))}async function a(t,e,n){let s=`id=${e.textContent}&status=${n}`;return await t.update(s)}function l(t){const e=s(t.target.closest("form"));let n="";return e.forEach((t=>{""===t.value&&(n+=`Поле ${t.name} является пустым. \n `)})),""===n||(alert(n),!1)}(async()=>{const o=document.querySelector("table"),c=document.querySelector("body"),i=document.querySelector(".container"),r=new n(o),d=new e,u=d.list();let m,h,f=document.querySelector(".add__ticket"),b=new t;try{let t=await u;0===t.length&&(i.style.position="relative",i.style.marginTop="0px",f.style.position="absolute",f.style.top="1px",f.style.right="1px"),r.allTickets(t),c.addEventListener("click",(async e=>{if("cancel"===e.target.className)b.remove();else if("verification"===e.target.className){let n=l(e);if(0==n)alert("Данные не прошли валидацию. \n Попробуйте ещё раз."),b.remove();else if(1==n){let n=await async function(t,e){const n=s(t.target.closest("form"));let a="";return n.forEach((t=>{a=a+t.name+"="+t.value+"&"})),a=a.slice(0,-1),await e.create(a)}(e,d),a=document.createElement("tr");a.className="table__row";const l=`\n          <td class="id">${n.id}</td>\n          <td class="status"><input type="checkbox" class="check"></td>\n          <td class="name">${n.name}</td>\n          <td class="created">${n.created}</td>\n          <td class="edit"><button type="button" class="edit__ticket">&#9998;</button></td>\n          <td class="delete"><button type="button" class="delete__ticket">&#10005;</button></td>\n          `;a.insertAdjacentHTML("beforeend",l),o.append(a),0===t.length&&(i.style.position="absolute",i.style.marginTop="50px",f.style.top="-45px",f.style.right="-1px",f.style.zIndex="999"),b.remove()}}else if("delete__record"===e.target.className){let t=await async function(t,e){let n=`id=${e.querySelector(".id").textContent}`;return await t.delete(n)}(d,m);if(204===t.status){const t=d.list();let e=await t;o.innerHTML="",r.allTickets(e),0===e.length?window.location.reload():(i.style.position="absolute",i.style.marginTop="50px")}b.remove()}else if("redact"===e.target.className){let t=l(e);if(0==t)alert("Данные не прошли валидацию. \n Попробуйте ещё раз."),b.remove();else if(1==t){let t=await async function(t,e,n){const a=s(t.target.closest("form"));let l=`id=${n.textContent}&`;return a.forEach((t=>{l=""!==t.value?l+t.name+"="+t.value+"&":l+t.name+"=&"})),l=l.slice(0,-1),await e.update(l)}(e,d,h);o.innerHTML="",r.allTickets(t),b.remove()}}})),o.addEventListener("click",(async t=>{m=t.target.closest(".table__row"),h=m.querySelector(".id");let e=await d.get(h.textContent),n=m.nextElementSibling;if("name"===t.target.className||"created"===t.target.className)if(""!==e.description&&null==n)m.insertAdjacentHTML("afterend",`<tr class="description"><td class="text__description" colspan="5">${e.description}</td></tr>`);else{if(null===n)return;n.remove()}else"delete__ticket"===t.target.className?(b.delete(),b.show()):"edit__ticket"===t.target.className?(b.edit(e),b.show()):"check"===t.target.className&&(t.target.checked?a(d,h,!0):a(d,h,!1))})),f.addEventListener("click",(()=>{b.create(),b.show()}))}catch(t){console.error(t)}})()})();